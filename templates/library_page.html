{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Library page</title>
    <link rel="stylesheet" type="text/css" href="{% static 'library/style.css' %}">
    <style>
      #player-bar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0; /* По умолчанию для десктопа */
        z-index: 20;
        background-color: rgba(31, 41, 55, 0.95); /* пример цвета */
        backdrop-filter: blur(12px);
        border-top: 1px solid rgba(75, 85, 99, 0.3);
      }

      /* Для мобильных устройств (например, ширина экрана до 768px) */
      @media (max-width: 768px) {
        #player-bar {
          bottom: 60px; /* поднимаем над мобильным nav */
        }
      }
    </style>
  </head>
  <body>
    <div id="library-page">
      <div class="w-screen h-screen flex justify-center">
        <div class="w-screen h-screen flex justify-center">
          <div
            class="w-screen h-screen bg-gradient-to-br from-gray-900 via-neutral-900 to-zinc-900 flex"
          >
            <nav
              class="hidden md:block w-[240px] bg-gray-800/30 backdrop-blur-lg p-6 relative border-r border-gray-700/30"
            >
              <div class="mb-8 flex items-center justify-center">
                <div class="relative w-32 h-32 group">
                  <div
                    class="absolute inset-0 bg-gradient-to-r from-gray-500 to-zinc-600 rounded-full blur-lg group-hover:blur-xl transition-all duration-300 opacity-50"
                  ></div>
                  <div
                    class="relative bg-gray-900 rounded-full w-full h-full flex items-center justify-center border-2 border-gray-500/30 group-hover:scale-105 transition-all duration-300"
                  >
                    <span
                      class="text-3xl font-bold bg-gradient-to-r from-gray-300 to-zinc-400 bg-clip-text text-transparent"
                      >AIMUZ</span
                    >
                  </div>
                </div>
              </div>
              <ul class="space-y-6 text-gray-300">
                <li
                  class="flex items-center gap-3 hover:text-gray-100 hover:translate-x-1 transition-all duration-200 cursor-pointer"
                >
                  <span class="material-symbols-outlined">home</span>
                  <a href="{% url 'main_page' %}">
                  <span>Главная страница</span>
                    </a>
                </li>
                <li
                  class="flex items-center gap-3 hover:text-gray-100 hover:translate-x-1 transition-all duration-200 cursor-pointer"
                >
                  <span class="material-symbols-outlined">add_box</span>
                  <a href="{% url 'music_page' %}">
                  <span>Создать</span>
                    </a>
                </li>
                <li
                  class="flex items-center gap-3 text-gray-100 translate-x-1 transition-all duration-200 cursor-pointer"
                >
                  <span class="material-symbols-outlined">library_music</span>
                  <a href="{% url 'library_page' %}">
                  <span>Библиотека</span>
                    </a>
                </li>
                <li
                  class="flex items-center gap-3 hover:text-gray-100 hover:translate-x-1 transition-all duration-200 cursor-pointer"
                >
                  <span class="material-symbols-outlined">person</span>
                  <a href="{% url 'profile_view' %}">
                  <span>Профиль</span>
                    </a>
                </li>
              </ul>
            </nav>
            <main class="flex-1 p-8 pb-32 overflow-y-auto relative">
              <div class="md:hidden flex justify-between items-center mb-6">
                <div class="relative w-10 h-10 group">
                  <div
                    class="absolute inset-0 bg-gradient-to-r from-gray-500 to-zinc-600 rounded-full blur-lg group-hover:blur-xl transition-all duration-300 opacity-50"
                  ></div>
                  <div
                    class="relative bg-gray-900 rounded-full w-full h-full flex items-center justify-center border-2 border-gray-500/30 group-hover:scale-105 transition-all duration-300"
                  >
                    <span
                      class="text-sm font-bold bg-gradient-to-r from-gray-300 to-zinc-400 bg-clip-text text-transparent"
                      >AI</span
                    >
                  </div>
                </div>
                <details class="relative">
                  <summary class="list-none">
                    <a href="{% url 'profile_view' %}">
                    <div
                      class="w-10 h-10 bg-gray-800/50 rounded-full flex items-center justify-center cursor-pointer hover:bg-gray-700/50 transition-colors"
                    >
                      <span class="material-symbols-outlined text-gray-300"
                        >person</span
                      >
                    </div>
                    </a>
                  </summary>
                </details>
              </div>
              <div class="max-w-6xl mx-auto">
                <h1
                  class="text-4xl font-bold text-center mb-12 bg-gradient-to-r from-gray-300 to-zinc-400 bg-clip-text text-transparent"
                >
                  Библиотека
                </h1>
                <div
                  class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
                >
                    {% if tracks %}
                    {% for track in tracks %}
                  <div
                    class="bg-gray-800/30 backdrop-blur-lg rounded-xl overflow-hidden group hover:transform hover:scale-[1.02] transition-all duration-300"
                  >
                    <div class="aspect-video relative overflow-hidden">
                      <img
                        src="{{ track.image_url }}"
                        alt="Music Cover"
                        class="w-full h-full object-cover group-hover:scale-110 transition-all duration-500"
                      />
                      <div
                        class="absolute inset-0 bg-gradient-to-t from-gray-900 to-transparent opacity-60"
                      ></div>
                      <button

                              onclick="playTrack('{{ track.audio_file.url }}', '{{ track.title }}', '{{ track.genre }}', '{{ track.image_url }}', this)"
                        class="absolute bottom-4 right-4 w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center text-gray-900 hover:scale-110 transition-transform duration-300"
                      >
                        <span class="material-symbols-outlined" id="play-icon-one"
                          >play_arrow</span
                        >
                      </button>
                    </div>
                    <div class="p-6">
                      <h3 class="text-xl font-bold text-gray-200 mb-2">
                        Трек {{ track.title }}
                      </h3>
                      <p class="text-gray-400 mb-4">Жанр: {{ track.genre }}</p>
                      <div class="flex items-center justify-between">
                        <span class="text-gray-500 text-sm">{{ track.duration|duration_format }}</span>
                        <div class="flex gap-2">
                          <a href="{% url 'edit_track' track.id %}"
                            class="p-2 hover:bg-gray-700/50 rounded-lg transition-colors"
                          >
                            <span
                              class="material-symbols-outlined text-gray-400"
                              >edit</span
                            >
                          </a>
                          <button
                            onclick="downloadTrack('{{ track.audio_file.url }}', '{{ track.title }}')"
                            class="p-2 hover:bg-gray-700/50 rounded-lg transition-colors"
                          >
                            <span
                              class="material-symbols-outlined text-gray-400"
                              >download</span
                            >
                          </button>
                          <button
                            onclick="copyTrackLink('http://127.0.0.1:8000/track/{{track.id}}/')"
                            class="p-2 hover:bg-gray-700/50 rounded-lg transition-colors"
                          >
                            <span
                              class="material-symbols-outlined text-gray-400"
                              >share</span
                            >
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                    {% endfor %}
                    {% else %}
                        <p>У вас пока нет сохранённых треков.</p>
                    {% endif %}

                </div>
              </div>
              <br><br><br><br><br>
            </main>
            <div
  id="player-bar"
  class="absolute left-0 right-0 bg-gray-800/95 backdrop-blur-lg border-t border-gray-700/30 hidden"
>
  <div class="max-w-6xl mx-auto px-6 py-4">
    <div class="flex items-center gap-4">
      <div class="w-16 h-16 rounded-lg overflow-hidden">
        <img
          id="player-cover"
          src="https://webcrumbs.cloud/placeholder"
          alt="Current Track"
          class="w-full h-full object-cover"
        />
      </div>
      <div class="flex-1">
        <h4 class="text-gray-200 font-semibold" id="player-track-title">Трек #1</h4>
        <p class="text-gray-400 text-sm" id="player-track-genre">Жанр</p>
      </div>
      <div class="flex items-center gap-6">
        <span class="text-gray-400 text-sm" id="player-time">0:00 / 0:00</span>
        <div class="flex items-center gap-4">
          <button
            class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-700/50 transition-colors"
            onclick="skipPrevious()"
          >
            <span class="material-symbols-outlined text-gray-300">skip_previous</span>
          </button>
          <button
            id="play-pause-btn"
            class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center text-gray-900 hover:scale-110 transition-transform duration-300"
            onclick="togglePlayPause()"
          >
            <span class="material-symbols-outlined" id="play-icon">play_arrow</span>
          </button>
          <button
            class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-700/50 transition-colors"
            onclick="skipNext()"
          >
            <span class="material-symbols-outlined text-gray-300">skip_next</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<audio id="audioPlayer" ontimeupdate="updatePlayerTime()" onloadedmetadata="updateDuration()">
  <source id="audioSource" type="audio/mpeg">
</audio>

            <nav
                    style="bottom:0px"
              class="md:hidden absolute left-0 right-0 h-16 bg-gray-800/90 backdrop-blur-lg border-t border-gray-700/30 flex justify-around items-center"
            >
              <a href="{% url 'main_page' %}">
                <span
                class="material-symbols-outlined p-3 hover:text-gray-100 hover:scale-110 transition-all cursor-pointer text-gray-300"
                >home</span
              >
              </a>
              <a href="{% url 'music_page' %}">
                <span
                class="material-symbols-outlined p-3 hover:text-gray-100 hover:scale-110 transition-all cursor-pointer text-gray-300"
                >add_box</span
              >
              </a>
              <a href="{% url 'library_page' %}">
              <span
                class="material-symbols-outlined p-3 hover:text-gray-100 hover:scale-110 transition-all cursor-pointer text-gray-300"
                >library_music</span
              >
                </a>
              <a href="{% url 'profile_view' %}">
              <span
                class="material-symbols-outlined p-3 hover:text-gray-100 hover:scale-110 transition-all cursor-pointer text-gray-300"
                >person</span
              >
                </a>
            </nav>
          </div>
        </div>
      </div>
    </div>

  <script>
        let currentTrackUrl = '';
        let currentPlayingButton = null;

        function playTrack(url, title, genre, coverUrl, buttonElement) {
          const audioPlayer = document.getElementById('audioPlayer');
          const audioSource = document.getElementById('audioSource');

          // Если выбран другой трек:
          if (currentTrackUrl !== url) {
            // Остановить предыдущий трек
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            currentTrackUrl = url;

            // Удалить активную иконку с предыдущей кнопки
            if (currentPlayingButton) {
              currentPlayingButton.querySelector('span').innerText = 'play_arrow';
            }

            // Загрузить новый трек
            audioSource.src = url;
            audioPlayer.load();
            audioPlayer.play();

            // Обновить интерфейс плеера
            document.getElementById('player-bar').classList.remove('hidden');
            document.getElementById('player-track-title').innerText = title;
            document.getElementById('player-track-genre').innerText = genre;
            document.getElementById('player-cover').src = coverUrl;

            // Поменять иконку на паузу у текущей кнопки
            buttonElement.querySelector('span').innerText = 'pause';
            currentPlayingButton = buttonElement;

            // Поменять иконку на глобальном плеере
            document.getElementById('play-icon').innerText = "pause";
          } else {
            // Если нажали повторно на тот же трек — просто пауза или воспроизведение
            togglePlayPause(buttonElement);
          }
        }

        function togglePlayPause(buttonElement = null) {
          const audioPlayer = document.getElementById('audioPlayer');
          const playIcon = document.getElementById('play-icon');

          if (audioPlayer.paused) {
            audioPlayer.play();
            playIcon.innerText = "pause";
            if (currentPlayingButton) {
              currentPlayingButton.querySelector('span').innerText = 'pause';
            }
          } else {
            audioPlayer.pause();
            playIcon.innerText = "play_arrow";
            if (currentPlayingButton) {
              currentPlayingButton.querySelector('span').innerText = 'play_arrow';
            }
          }
        }


        function updatePlayerTime() {
          const audioPlayer = document.getElementById('audioPlayer');
          const currentTimeFormatted = formatTime(audioPlayer.currentTime);
          const durationFormatted = formatTime(audioPlayer.duration || currentTrackDuration);
          document.getElementById('player-time').innerText = `${currentTimeFormatted} / ${durationFormatted}`;
        }

        function updateDuration() {
          const audioPlayer = document.getElementById('audioPlayer');
          currentTrackDuration = audioPlayer.duration;
          updatePlayerTime();
        }

        function formatTime(seconds) {
          const min = Math.floor(seconds / 60);
          const sec = Math.floor(seconds % 60).toString().padStart(2, '0');
          return `${min}:${sec}`;
        }

        // Можешь добавить skipPrevious() и skipNext() если хочешь управлять списком
        function skipPrevious() { /* опционально */ }
        function skipNext() { /* опционально */ }

        function downloadTrack(url, title) {
          const link = document.createElement('a');
          link.href = url;
          link.download = `${title}.mp3`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }

        function copyTrackLink(url) {
          navigator.clipboard.writeText(url).then(() => {
            alert('Ссылка на трек скопирована!');
          }).catch(err => {
            console.error('Ошибка копирования ссылки:', err);
          });
        }



    </script>
  </body>
</html>