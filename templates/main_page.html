{% load static %}
{% load custom_filters %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Main Page</title>
    <link rel="stylesheet" type="text/css" href="{% static 'main_page_style/style.css' %}">
    <style>
      #player-bar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0; /* По умолчанию для десктопа */
        z-index: 20;
        background-color: rgba(31, 41, 55, 0.95); /* пример цвета */
        backdrop-filter: blur(12px);
        border-top: 1px solid rgba(75, 85, 99, 0.3);
      }

      /* Для мобильных устройств (например, ширина экрана до 768px) */
      @media (max-width: 768px) {
        #player-bar {
          bottom: 60px; /* поднимаем над мобильным nav */
        }
      }
    </style>
  </head>
  <body>
    <div id="main-page">
      <div class="w-screen h-screen flex justify-center">
        <div class="w-screen h-screen flex justify-center">
          <div
            class="w-screen h-screen bg-gradient-to-br from-gray-900 via-neutral-900 to-zinc-900 flex"
          >
            <nav
              class="hidden md:block w-[240px] bg-gray-800/30 backdrop-blur-lg p-6 relative border-r border-gray-700/30"
            >
              <div class="mb-8 flex items-center justify-center">
                <div class="relative w-32 h-32 group">
                  <div
                    class="absolute inset-0 bg-gradient-to-r from-gray-500 to-zinc-600 rounded-full blur-lg group-hover:blur-xl transition-all duration-300 opacity-50"
                  ></div>
                  <div
                    class="relative bg-gray-900 rounded-full w-full h-full flex items-center justify-center border-2 border-gray-500/30 group-hover:scale-105 transition-all duration-300"
                  >
                    <span
                      class="text-3xl font-bold bg-gradient-to-r from-gray-300 to-zinc-400 bg-clip-text text-transparent"
                      >AIMUZ</span
                    >
                  </div>
                </div>
              </div>
              <ul class="space-y-6 text-gray-300">

                  <li
                  class="flex items-center gap-3 hover:text-gray-100 hover:translate-x-1 transition-all duration-200 cursor-pointer"
                >
                    <span class="material-symbols-outlined">home</span>
                    <a href="{% url 'main_page' %}">
                    <span>Главная страница</span>
                      </a>
                </li>
                  <li
                  class="flex items-center gap-3 hover:text-gray-100 hover:translate-x-1 transition-all duration-200 cursor-pointer"
                >

                  <span class="material-symbols-outlined">add_box</span>
                    <a href="{% url 'music_page' %}">
                  <span>Создать</span>
                    </a>
                </li>
                <li
                  class="flex items-center gap-3 hover:text-gray-100 hover:translate-x-1 transition-all duration-200 cursor-pointer"
                >
                  <span class="material-symbols-outlined">library_music</span>
                  <a href="{% url 'library_page' %}">
                    <span>Библиотека</span>
                  </a>
                </li>
                <li
                  class="flex items-center gap-3 hover:text-gray-100 hover:translate-x-1 transition-all duration-200 cursor-pointer"
                >
                  <span class="material-symbols-outlined">person</span>
                  <a href="{% url 'profile_view' %}">
                  <span>Профиль</span>
                    </a>
                </li>
              </ul>
            </nav>
            <main class="flex-1 p-8 overflow-y-auto relative">
              <div class="md:hidden flex justify-between items-center mb-6">
                <div class="relative w-10 h-10 group">
                  <div
                    class="absolute inset-0 bg-gradient-to-r from-gray-500 to-zinc-600 rounded-full blur-lg group-hover:blur-xl transition-all duration-300 opacity-50"
                  ></div>
                  <div
                    class="relative bg-gray-900 rounded-full w-full h-full flex items-center justify-center border-2 border-gray-500/30 group-hover:scale-105 transition-all duration-300"
                  >
                    <span
                      class="text-sm font-bold bg-gradient-to-r from-gray-300 to-zinc-400 bg-clip-text text-transparent"
                      >AI</span
                    >
                  </div>
                </div>
                <details class="relative">
                  <summary class="list-none">
                    <a href="{% url 'profile_view' %}">
                    <div
                      class="w-10 h-10 bg-gray-800/50 rounded-full flex items-center justify-center cursor-pointer hover:bg-gray-700/50 transition-colors"
                    >
                      <span class="material-symbols-outlined text-gray-300"
                        >person</span
                      >
                    </div>
                    </a>
                  </summary>

                </details>
              </div>
              <section class="mb-12">
                <h2
                  class="text-3xl font-bold mb-6 bg-gradient-to-r from-gray-300 to-zinc-400 bg-clip-text text-transparent"
                >
                  Треки сообщества
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% for track in tracks %}
                  <div
                    class="bg-gray-800/30 backdrop-blur-lg rounded-xl p-4 hover:scale-105 hover:shadow-xl hover:shadow-gray-500/10 transition-all duration-300 cursor-pointer group"
                  >
                    <div class="relative mb-4 overflow-hidden rounded-lg">
                      <img
                        src="{{ track.image_url }}"
                        class="w-full h-[120px] sm:h-[160px] object-cover transform group-hover:scale-110 transition-transform duration-300"
                        alt="{{ track.title }}"
                      />
                      <span
                        class="absolute top-2 right-2 bg-gray-900/80 backdrop-blur-sm px-2 py-1 rounded text-sm text-gray-300"
                        >{{ track.duration|duration_format }}</span
                      >
                      <button
                        onclick="showTrackDetails({
    title: '{{ track.title|escapejs }}',
    genre: '{{ track.genre|escapejs }}',
    author: '{{ track.user.username|escapejs }}',
    date: '{{ track.created_at|date:'d.m.Y' }}',
    lyrics: `{{ track.lyrics|escapejs }}`,
    coverUrl: '{{ track.image_url }}',
    audioUrl: '{{ track.audio_file.url }}',
    buttonId: 'play-icon-{{ track.id }}'
  })"
                        class="absolute inset-0 m-auto w-14 h-14 bg-gradient-to-r from-gray-500 to-zinc-600 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-300 hover:from-gray-600 hover:to-zinc-700 hover:scale-110"
                      >
                        <span id="play-icon-{{ track.id }}" class="material-symbols-outlined text-gray-200"
                          >play_arrow</span
                        >
                      </button>
                    </div>
                    <div class="flex justify-between items-start">
                      <div>
                        <a href="{% url 'track_detail' track.id %}">
                        <h3
                          class="font-semibold mb-1 group-hover:text-gray-100 transition-colors text-gray-300"
                        >
                          {{ track.title }}
                        </h3>
                          </a>
                        <p class="text-sm text-gray-400">Artist Name: {{ track.user.username }}</p>
                        <span
                          class="inline-block bg-gray-700/30 backdrop-blur-sm text-xs px-3 py-1 rounded-full mt-2 hover:bg-gray-600/30 transition-colors text-gray-300"
                          >{{ track.genre }}</span
                        >
                      </div>
                      <div class="text-sm text-gray-400 space-y-2">
                        <div
                          class="flex items-center gap-1 hover:text-gray-200 transition-colors cursor-pointer"
                        >
                          <span class="material-symbols-outlined text-sm"
                            >favorite</span
                          >
                          <span>{{ track.likes_count }}</span>
                        </div>
                        <div
                          class="flex items-center gap-1 hover:text-gray-200 transition-colors cursor-pointer"
                        >
                          <span class="material-symbols-outlined text-sm"
                            >visibility</span
                          >
                          <span>{{ track.listens_count }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                    {% endfor %}
                </div>
              </section>
              <br><br><br><br><br>
            </main>
            <aside
              class="hidden md:block w-[320px] bg-gray-800/30 backdrop-blur-lg p-6 border-l border-gray-700/30 overflow-y-auto"
            >
              <div class="mb-6">
                <div class="relative mb-4 group cursor-pointer">
                  <img
                    id="details-cover"
                    src="https://webcrumbs.cloud/placeholder"
                    class="w-full h-[320px] object-cover rounded-xl"
                    alt="Current track"
                  />

                </div>
                <div class="flex flex-col gap-4">
                  <h3 id="details-title"
                    class="text-xl font-bold mb-2 hover:text-gray-100 transition-colors cursor-pointer text-gray-300"
                  >
                    Название текущего трека
                  </h3>
                </div>
                <p class="text-gray-400 mb-4" id="details-author">Имя исполнителя</p>
                <div class="flex items-center gap-4 mb-6">
                  <span id="details-genre"
                    class="bg-gray-700/30 backdrop-blur-sm text-xs px-3 py-1 rounded-full hover:bg-gray-600/30 transition-colors cursor-pointer text-gray-300"
                    >Жанр</span
                  >
                  <span class="text-gray-400 text-sm"
                    id="details-date">Загружено:</span
                  >
                </div>
                <div class="space-y-4 text-gray-300" id="details-lyrics">

                </div>
              </div>

            </aside>
            <nav
              class="md:hidden absolute bottom-0 left-0 right-0 h-16 bg-gray-800/90 backdrop-blur-lg border-t border-gray-700/30 flex justify-around items-center"
            >
              <a href="{% url 'main_page' %}">
                <span
                class="material-symbols-outlined p-3 hover:text-gray-100 hover:scale-110 transition-all cursor-pointer text-gray-300"
                >home</span
              >
              </a>
              <a href="{% url 'music_page' %}">
                <span
                class="material-symbols-outlined p-3 hover:text-gray-100 hover:scale-110 transition-all cursor-pointer text-gray-300"
                >add_box</span
              >
              </a>
              <a href="{% url 'library_page' %}">
              <span
                class="material-symbols-outlined p-3 hover:text-gray-100 hover:scale-110 transition-all cursor-pointer text-gray-300"
                >library_music</span
              >
                </a>
              <a href="{% url 'profile_view' %}">
              <span
                class="material-symbols-outlined p-3 hover:text-gray-100 hover:scale-110 transition-all cursor-pointer text-gray-300"
                >person</span
              >
                </a>
            </nav>
            <div
  id="player-bar"
  class="absolute left-0 right-0 bg-gray-800/95 backdrop-blur-lg border-t border-gray-700/30 hidden"
>
  <div class="max-w-6xl mx-auto px-6 py-4">
    <div class="flex items-center gap-4">
      <div class="w-16 h-16 rounded-lg overflow-hidden">
        <img
          id="player-cover"
          src="https://webcrumbs.cloud/placeholder"
          alt="Current Track"
          class="w-full h-full object-cover"
        />
      </div>
      <div class="flex-1">
        <h4 class="text-gray-200 font-semibold" id="player-track-title">Трек #1</h4>
        <p class="text-gray-400 text-sm" id="player-track-genre">Жанр</p>
      </div>
      <div class="flex items-center gap-6">
        <span class="text-gray-400 text-sm" id="player-time">0:00 / 0:00</span>
        <div class="flex items-center gap-4">
          <button
            class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-700/50 transition-colors"
            onclick="skipPrevious()"
          >
            <span class="material-symbols-outlined text-gray-300">skip_previous</span>
          </button>
          <button
            id="play-pause-btn"
            class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center text-gray-900 hover:scale-110 transition-transform duration-300"
            onclick="togglePlayPause()"
          >
            <span class="material-symbols-outlined" id="play-icon">play_arrow</span>
          </button>
          <button
            class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-700/50 transition-colors"
            onclick="skipNext()"
          >
            <span class="material-symbols-outlined text-gray-300">skip_next</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
            <audio id="audioPlayer" ontimeupdate="updateProgress()">
  <source id="audioSource" type="audio/mpeg">
</audio>
          </div>
        </div>
      </div>
    </div>
  <script>
 // Синхронизация плеера, карточки и боковой панели
let currentTrackButtonId = null;
let currentAudioUrl = null;

function showTrackDetails(track) {
  const audioPlayer = document.getElementById('audioPlayer');
  const audioSource = document.getElementById('audioSource');

  // Если этот же трек уже играет — ставим на паузу или возобновляем
  if (currentAudioUrl === track.audioUrl) {
    if (audioPlayer.paused) {
      audioPlayer.play();
      document.getElementById('play-icon').innerText = 'pause';
      if (currentTrackButtonId) {
        document.getElementById(currentTrackButtonId).innerText = 'pause';
      }
    } else {
      audioPlayer.pause();
      document.getElementById('play-icon').innerText = 'play_arrow';
      if (currentTrackButtonId) {
        document.getElementById(currentTrackButtonId).innerText = 'play_arrow';
      }
    }
    return;
  }

  // Сброс иконок
  document.querySelectorAll('[id^="play-icon-"]').forEach(el => el.innerText = 'play_arrow');

  // Обновляем детали
  document.getElementById('details-title').innerText = track.title;
  document.getElementById('details-genre').innerText = track.genre;
  document.getElementById('details-author').innerText = track.author;
  document.getElementById('details-date').innerText = track.date;
  document.getElementById('details-lyrics').innerText = track.lyrics;
  document.getElementById('details-cover').src = track.coverUrl;

  // Загружаем и играем новый трек
  audioSource.src = track.audioUrl;
  audioPlayer.load();
  audioPlayer.play();

  currentAudioUrl = track.audioUrl;

  document.getElementById('player-cover').src = track.coverUrl;
  document.getElementById('player-track-title').innerText = track.title;
  document.getElementById('player-track-genre').innerText = track.genre;
  document.getElementById('player-bar').classList.remove('hidden');

  if (track.buttonId) {
    document.getElementById(track.buttonId).innerText = 'pause';
    currentTrackButtonId = track.buttonId;
  }
  document.getElementById('play-icon').innerText = 'pause';
}

function togglePlayPause() {
  const audioPlayer = document.getElementById('audioPlayer');
  const playIcon = document.getElementById('play-icon');

  if (audioPlayer.paused) {
    audioPlayer.play();
    playIcon.innerText = 'pause';
    if (currentTrackButtonId) {
      document.getElementById(currentTrackButtonId).innerText = 'pause';
    }
  } else {
    audioPlayer.pause();
    playIcon.innerText = 'play_arrow';
    if (currentTrackButtonId) {
      document.getElementById(currentTrackButtonId).innerText = 'play_arrow';
    }
  }
}

function updateProgress() {
  const audioPlayer = document.getElementById('audioPlayer');
  const currentTime = formatTime(audioPlayer.currentTime);
  const duration = formatTime(audioPlayer.duration || 0);
  document.getElementById('player-time').innerText = `${currentTime} / ${duration}`;
}

function formatTime(seconds) {
  const min = Math.floor(seconds / 60);
  const sec = Math.floor(seconds % 60).toString().padStart(2, '0');
  return `${min}:${sec}`;
}

function skipPrevious() { audioPlayer.currentTime = 0; }
function skipNext() { audioPlayer.currentTime = audioPlayer.duration; }


    </script>
  </body>
</html>